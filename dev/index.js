// const response = [[{"price": "$7.00", "sale": false, "input_name": "Ground beef", "name": "Western Canadian - Ground Beef Lean, 454 Gram", "unit": "n/a", "store": "Save on Foods", "img_link": "https://storage.googleapis.com/images-sof-prd-9fa6b8b.sof.prd.v8.commerce.mi9cloud.com/product-images/cell/00056364902603.jpg", "store_link": "https://www.saveonfoods.com/sm/pickup/rsid/2241/product/western-canadian-ground-beef-lean-id-00056364902603"}, {"price": "$8.00", "sale": false, "input_name": "Ground beef", "name": "Western Canadian - Extra Lean Ground Beef, 454 Gram", "unit": "n/a", "store": "Save on Foods", "img_link": "https://storage.googleapis.com/images-sof-prd-9fa6b8b.sof.prd.v8.commerce.mi9cloud.com/product-images/cell/00062639375201.jpg", "store_link": "https://www.saveonfoods.com/sm/pickup/rsid/2241/product/western-canadian-extra-lean-ground-beef-id-00062639375201"}, {"price": "$12.28 avg/ea", "sale": true, "input_name": "Ground beef", "name": "Western Canadian - Ground Beef Extra Lean, 0.93 Kilogram", "unit": "n/a", "store": "Save on Foods", "img_link": "https://storage.googleapis.com/images-sof-prd-9fa6b8b.sof.prd.v8.commerce.mi9cloud.com/product-images/cell/00290081000000.jpg", "store_link": "https://www.saveonfoods.com/sm/pickup/rsid/2241/product/western-canadian-ground-beef-extra-lean-id-00290081000000"}, {"input_name": "Ground beef", "name": "Crave - Smokey BBQ Angus Beef Frozen Meal (ea)", "price_per_unit": "5.29", "unit": "ea", "store": "No Frills", "img_link": "https://assets.shop.loblaws.ca/products/21174605_EA/b1/en/front/21174605_EA_front_a01.png", "store_link": "https://www.nofrills.ca/smokey-bbq-angus-beef-frozen-meal/p/21174605_EA", "sale": false}, {"input_name": "Ground beef", "name": "Crave - Cheesy Loaded Potatoes with Angus Beef Frozen Meal (ea)", "price_per_unit": "5.29", "unit": "ea", "store": "No Frills", "img_link": "https://assets.shop.loblaws.ca/products/21239301_EA/b1/en/front/21239301_EA_front_a01.png", "store_link": "https://www.nofrills.ca/cheesy-loaded-potatoes-with-angus-beef-frozen-meal/p/21239301_EA", "sale": false}, {"input_name": "Ground beef", "name": "Crave - Meat & Potatoes, Smokehouse Style (ea)", "price_per_unit": "5.29", "unit": "ea", "store": "No Frills", "img_link": "https://assets.shop.loblaws.ca/products/21553457_EA/b1/en/front/21553457_EA_front_a01.png", "store_link": "https://www.nofrills.ca/meat-potatoes-smokehouse-style/p/21553457_EA", "sale": false}], [{"price": "$5.89", "sale": false, "input_name": "Milk", "name": "Silk - Oat Yeah - Vanilla Oat Beverage, 1.75 Litre", "unit": "n/a", "store": "Save on Foods", "img_link": "https://storage.googleapis.com/images-sof-prd-9fa6b8b.sof.prd.v8.commerce.mi9cloud.com/product-images/cell/00036632072412.jpg", "store_link": "https://www.saveonfoods.com/sm/pickup/rsid/2241/product/silk-oat-yeah-vanilla-oat-beverage-id-00036632072412"}, {"price": "$6.19", "sale": false, "input_name": "Milk", "name": "Silk - High Protein Unsweetened Vanilla, 1.75 Litre", "unit": "n/a", "store": "Save on Foods", "img_link": "https://storage.googleapis.com/images-sof-prd-9fa6b8b.sof.prd.v8.commerce.mi9cloud.com/product-images/cell/00036632072344.jpg", "store_link": "https://www.saveonfoods.com/sm/pickup/rsid/2241/product/silk-high-protein-unsweetened-vanilla-id-00036632072344"}, {"price": "$6.19", "sale": false, "input_name": "Milk", "name": "Silk - Nextmilk Plant-Based Dairy-Free Milk Alternative, Regular,, 1.74 Litre", "unit": "n/a", "store": "Save on Foods", "img_link": "https://storage.googleapis.com/images-sof-prd-9fa6b8b.sof.prd.v8.commerce.mi9cloud.com/product-images/cell/00036632078506.jpg", "store_link": "https://www.saveonfoods.com/sm/pickup/rsid/2241/product/silk-nextmilk-plantbased-dairyfree-milk-alternative-regular-id-00036632078506"}, {"input_name": "Milk", "name": "Neilson - Partly Skimmed Milk 2% MF (ea)", "price_per_unit": "5.89", "unit": "ea", "store": "No Frills", "img_link": "https://assets.shop.loblaws.ca/products/20188873_EA/b1/en/front/20188873_EA_front_a01.png", "store_link": "https://www.nofrills.ca/partly-skimmed-milk-2-mf/p/20188873_EA", "sale": false}, {"input_name": "Milk", "name": "Neilson - Partly Skimmed Milk 1% MF (ea)", "price_per_unit": "5.89", "unit": "ea", "store": "No Frills", "img_link": "https://assets.shop.loblaws.ca/products/20047439_EA/b1/en/front/20047439_EA_front_a01.png", "store_link": "https://www.nofrills.ca/partly-skimmed-milk-1-mf/p/20047439_EA", "sale": false}, {"input_name": "Milk", "name": "Neilson - Homogenized Milk 3.25% (ea)", "price_per_unit": "6.89", "unit": "ea", "store": "No Frills", "img_link": "https://assets.shop.loblaws.ca/products/20160571_EA/b1/en/front/20160571_EA_front_a01.png", "store_link": "https://www.nofrills.ca/homogenized-milk-3-25/p/20160571_EA", "sale": false}], [{"price": "$4.49", "sale": true, "input_name": "Bread", "name": "Dempster's - Multigrain Bread, 600 Gram", "unit": "n/a", "store": "Save on Foods", "img_link": "https://storage.googleapis.com/images-sof-prd-9fa6b8b.sof.prd.v8.commerce.mi9cloud.com/product-images/cell/00068721712480.jpg", "store_link": "https://www.saveonfoods.com/sm/pickup/rsid/2241/product/dempsters-multigrain-bread-id-00068721712480"}, {"price": "$3.79", "sale": false, "input_name": "Bread", "name": "Wonder - Bread - White Soft, 570 Gram", "unit": "n/a", "store": "Save on Foods", "img_link": "https://storage.googleapis.com/images-sof-prd-9fa6b8b.sof.prd.v8.commerce.mi9cloud.com/product-images/cell/00064947130220.jpg", "store_link": "https://www.saveonfoods.com/sm/pickup/rsid/2241/product/wonder-bread-white-soft-id-00064947130220"}, {"price": "$3.79", "sale": false, "input_name": "Bread", "name": "Wonder - Bread - White + Fibre, 570 Gram", "unit": "n/a", "store": "Save on Foods", "img_link": "https://storage.googleapis.com/images-sof-prd-9fa6b8b.sof.prd.v8.commerce.mi9cloud.com/product-images/cell/00063400021303.jpg", "store_link": "https://www.saveonfoods.com/sm/pickup/rsid/2241/product/wonder-bread-white-fibre-id-00063400021303"}, {"input_name": "Bread", "name": "No Name - Original Bread (ea)", "price_per_unit": "1.99", "unit": "ea", "store": "No Frills", "img_link": "https://assets.shop.loblaws.ca/products/21509822_EA/b1/en/front/21509822_EA_front_a01.png", "store_link": "https://www.nofrills.ca/original-bread/p/21509822_EA", "sale": false}, {"input_name": "Bread", "name": "No Name - 100% Whole Wheat Bread (ea)", "price_per_unit": "1.99", "unit": "ea", "store": "No Frills", "img_link": "https://assets.shop.loblaws.ca/products/21509877_EA/b1/en/front/21509877_EA_front_a01.png", "store_link": "https://www.nofrills.ca/100-whole-wheat-bread/p/21509877_EA", "sale": false}, {"input_name": "Bread", "name": "Dempster - White Bread (ea)", "price_per_unit": "3.49", "unit": "ea", "store": "No Frills", "img_link": "https://assets.shop.loblaws.ca/products/20187958_EA/b1/en/front/20187958_EA_front_a01.png", "store_link": "https://www.nofrills.ca/white-bread/p/20187958_EA", "sale": true}]]
const tableDiv = document.getElementById("tableDiv");
const tbody = document.getElementById("itemsTableBody");
const totalPrice = document.getElementById("totalPriceCell");
const groceryDataList = document.getElementById("groceryItems");
const items_list = ["Eggs", "Milk", "Bread", "Chicken breast", "Ground beef", "Rice", "Pasta", "Apple", "Banana", "Orange", "Potato", "Cracker", "Lettuce", "Cheese", "Yogurt", "Peanut butter", "Cereal", "Chips", "Coffee", "Canola oil"]
items_list.sort();
var to_fetch = [];
const profileID = "1233445"

function fetchGroceryList() {
    fetch(`https://ozfhk0stlj.execute-api.us-west-2.amazonaws.com/dev/users?id=${profileID}`)
    .then(resp => resp.json())
    .then(data => fetchGroceryItemPrices(data.items))
    .catch(err => {
        console.log("There was an error while fetching: ", err);
    })
}

function fetchGroceryItemPrices(data) {
    console.log(data);
    let url = "https://ozfhk0stlj.execute-api.us-west-2.amazonaws.com/dev/prices?";
    for (var i = 0; i < data.length; i++) {
        if (i == 0) {
            url = url + "input=" + data[i];
        } else {
            url = url + "&input=" + data[i];
        }
    }
    fetch(url)
    .then(resp => resp.json())
    .then(data => handleResponse(data))
    .catch(err => {
        console.log("There was an error while fetching prices: ", err);
    })
}

function handleResponse(response) {
    console.log(response);
    for (var i = 0; i < response.length; i++) {
        var items = response[i];
        if (items.length == 0) {
            continue;
        }
        const save_on_items = items.filter((item) => item.store === "Save on Foods");
        const no_frills_items = items.filter((item) => item.store === "No Frills");
    
        save_on_price = averagePrice(save_on_items);
        no_frills_price = averagePrice(no_frills_items);
    
        if (save_on_price >= no_frills_price) {
            insertRow({"name": items[0].input_name, "price": save_on_price, "store": "Save on Foods"});
        } else {
            insertRow({"name": items[0].input_name, "price": no_frills_price, "store": "No Frills"});
        }
    }
    console.log("Item prices were read successfully");
}

function averagePrice(items) {
    let sum = 0;
    for (var i = 0; i < items.length; i++) {
        let price = items[i].price
        
        if (price != undefined) {
            price = parseFloat(price.substring(1));
        } else {
            price = items[i].price_per_unit;
            price = parseFloat(price);
        }

        sum += price;
    }
    if (items.length == 0) {
        return 0;
    } else {
        return Math.round(sum / items.length * 100) / 100;
    }
}

function insertRow(item) {
    const newRow = document.createElement("tr");
    const newCell = newRow.insertCell(-1);
    newCell.innerText = item["name"];
    const newCell2 = newRow.insertCell(-1);
    newCell2.innerText = item["store"];
    const newCell3 = newRow.insertCell(-1);
    newCell3.innerText = "$" + item["price"];
    tbody.append(newRow);

    recalculateTotal(item["price"]);
}

function recalculateTotal(price) {
    let curPrice = parseFloat(totalPriceCell.innerText.substring(1));
    curPrice += price;
    curPrice = Math.round(curPrice * 100) / 100
    totalPriceCell.innerText = "$" + curPrice;
}

function generateDatalistItems() {
    items_list.forEach((item) => {
        var option = document.createElement("option");
        option.value = item;
        groceryDataList.appendChild(option);
    })
}

fetchGroceryList();
generateDatalistItems();